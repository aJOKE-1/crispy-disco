#include <stdio.h>
#include <conio.h>
#include <stdlib.h>
#include <time.h>
#include <windows.h>

#define head 0
char map[30][30];
int snake[900][3]={0};
int food[2];
int H=30,W=30;
int length=3,x,y;//x、y储存原蛇头位置
char key,direct='s';
void init(char map[H][W],int snake[900][3]);//初始化地图 蛇
void getkey();//得到运动指令
void makefood(int food[]);//制作食物
void makemap(char map[H][W],int snake[900][3],int food[2]);//制作蛇身 食物
void showmap(char map[H][W]);//显示地图
void move(int direct,int length,int snake[900][3]);//蛇移动
int ifreapt(int snake[900][3],int food[2]);//判断是否重复
int ifeat(int snake[900][3],int food[2]);//判断是否能吃到食物
int pengzhuang1(int snake[900][3],int direct);//判断是否撞墙
int pengzhuang2(int snake[900][3],int direct);//撞身

void init(char map[H][W],int snake[900][3])
{
    snake[head][0]=3,snake[head][1]=1,snake[head][2]=1;
    snake[1][0]=1,snake[1][1]=1,snake[1][2]=1;
    snake[2][0]=2,snake[2][1]=1,snake[2][2]=1;
    for (int i = 0; i<H; i++) {
		for (int j = 0; j<W; j++) {
			if (i == 0 || j == 0 || i == H - 1 || j == W - 1) {
				map[i][j] = '*';
			}
			else {
				map[i][j] = ' ';
			}
    srand(time(0));
    food[0]=rand()%29,food[1]=rand()%29;
}
    }
}

void getkey()
{
    if(kbhit()) key = _getch();
    switch(key)
    {
        case('w'):if(direct!='s') direct='w';break;
        case('s'):if(direct!='w') direct='s';break;
        case('a'):if(direct!='d') direct='a';break;
        case('d'):if(direct!='a') direct='d';break;
    }

}

void makefood(int food[2])
{
    srand(time(0));
    food[0]=rand()%29,food[1]=rand()%29;
    while(ifreapt(snake,food)||food[0]==0||food[1]==0) food[0]=rand()%29,food[1]=rand()%29;
}

void makemap(char map[H][W],int snake[900][3],int food[2])
{
    int i;
    for(i=1;i<length;i++)
        if(snake[i][0]!=0&&snake[i][1]!=0) map[snake[i][0]][snake[i][1]]='#';
    map[snake[head][0]][snake[head][1]]='&';
    map[food[0]][food[1]]='o';
}

void showmap(char map[H][W])
{
    for (int i = 0; i<30; i++) {
		for (int j = 0; j<30; j++) {
			printf("%c", map[i][j]);
		}
		printf("\n");
	}
}

void move(int direct,int length,int snake[900][3])
{
    int i,x,y;
    int temp1,temp2;
    x=snake[head][0];
    y=snake[head][1];
    switch (direct){
        case('w'):snake[head][0]--;break;
        case('s'):snake[head][0]++;break;
        case('a'):snake[head][1]--;break;
        case('d'):snake[head][1]++;break;}
        if(ifeat(snake,food)){
            snake[length-1][0]=x;
            snake[length-1][1]=y;
            snake[length-1][2]=1;
        }
        else {
            for(i=1;i<length;i++) snake[i][2]=0;
            for(i=length-1;i;i--)
        {
            temp1=snake[i][0],temp2=snake[i][1];
            snake[i][0]=x,snake[i][1]=y,snake[i][2]=1;
            x=temp1,y=temp2;
        }}
}

int ifreapt(int snake[900][3],int food[2])
{
    int i;
    for(i=0;i<length;i++)
    if(snake[i][0]==food[0]&&snake[i][1]==food[1]||food[0]==0||food[1]==0) {return 1; exit(0);}//**
    return 0;
}

int ifeat(int snake[900][3],int food[2])
{
    if (snake[head][0] == food[0] && snake[head][1] == food[1])
		{length++;
		return 1;}
	else
		return 0;
}

int pengzhuang1(int snake[900][3],int length)
{
    for(int i=1;i<length;i++)
    {
        //if(snake[head][0]==0||snake[head][0]==29||snake[head][1]==0||snake[head][1]==29) return 1;
        //else if(snake[i][0]==snake[head][0]&&snake[i][1]==snake[head][1])return 1;
        //else return 0;}
        if(snake[i][0]==snake[head][0]&&snake[i][1]==snake[head][1]) return 1;
        else return 0;
        //if(!(snake[head][0]==0||snake[head][0]==29||snake[head][1]==0||snake[head][1]==29)&&!(snake[i][0]==snake[head][0]&&snake[i][1]==snake[head][1]))
         //   return 0;
        //else return 1;
}
}

int pengzhuang2(int snake[900][3],int direct)
{
    if(snake[head][0]==0||snake[head][0]==29||snake[head][1]==0||snake[head][1]==29) return 1;
    else return 0;
}
int main()
{
    init(map,snake);
    showmap(map);
    while(1)
    {
        getkey();
        move(direct,length,snake);
        if(snake[head][0]==food[0]&&snake[head][1]==food[1])
            makefood(food);//是否吃掉食物
        if(pengzhuang1(snake,direct)) {printf("游戏结束，你的成绩为%d",length);break;}
        if(pengzhuang2(snake,direct)) {printf("游戏结束，你的成绩为%d",length);break;}
        system("cls");
        Sleep(33);
        makemap(map,snake,food);
        showmap(map);
    }
    return 0;
}
